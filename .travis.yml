#
# 
# Notes:
# - the SCons Python package must be installed using Python 2.x even if
#   testing Python 3.x. Scons is only required to build gpsd.

language: python

addons:
  apt:
    packages:
    - swig
    - mercurial
    
python:
  - 2.6
  - 2.7
  - 3.5

  
branches:
  only:
    - master
    - develop

before_install:
  - cd $HOME 
  - hg clone https://bitbucket.org/scons/scons
  - cd scons
  - /usr/bin/python2 bootstrap.py build/scons
  - cd build/scons
  - /usr/bin/python2 setup.py install --prefix=$HOME
  - ls $HOME/bin $HOME
  - pip${TRAVIS_PYTHON_VERSION} install --upgrade pip
  - pip${TRAVIS_PYTHON_VERSION} install --upgrade setuptools
  - pip${TRAVIS_PYTHON_VERSION} install --upgrade codecov
  
before_script:
  - cd $HOME
  - git clone git://git.savannah.nongnu.org/gpsd.git
  - cd gpsd
  - git checkout master && git pull origin master
  - /usr/bin/python2 $HOME/bin/scons export_shm=yes python=no prefix=$HOME
  - /usr/bin/python2 $HOME/bin/scons install
  
install:
  - cd $TRAVIS_BUILD_DIR
  - pip install -r requirements.txt
  - pip install -r test_requirements.txt
  - pip install coverage

after_success:
  - codecov

# command to run tests, e.g. python setup.py test
script: 
  - cd $TRAVIS_BUILD_DIR/gpsdshm
  - swig -python shm.i
  - cd $TRAVIS_BUILD_DIR
  - CPATH=$HOME/include LIBRARY_PATH=$HOME/lib python${TRAVIS_PYTHON_VERSION} setup.py build_ext --inplace
  - python${TRAVIS_PYTHON_VERSION} `which nosetests` -v tests/
